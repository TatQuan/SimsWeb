@using SimsWeb.ViewModels
@model AssignmentDetailViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Assignment Details";
    var message = TempData["AssignmentMessage"] as string;
}

<h4 class="mb-3">Assignment Details</h4>

@if (!string.IsNullOrWhiteSpace(message))
{
    <div class="alert alert-info">@message</div>
}

<div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
        <h5 class="card-title mb-1">@Model.Title</h5>
        <div class="text-muted small mb-2">
            Class: @Model.ClassCode @if (!string.IsNullOrWhiteSpace(Model.ClassName)) {
            <span>- @Model.ClassName</span>
                        }
<br />
            Course: @Model.CourseName<br />
            Teacher: @Model.TeacherName
        </div>
        <div class="mb-2">
            <strong>Deadline:</strong>
            @Model.DueAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
            @if (Model.IsPastDeadline)
            {
                <span class="badge bg-danger ms-1">Past deadline</span>
            }
        </div>

        @if (Model.ExerciseFilePath != null || Model.GuideFilePath != null)
        {
            <div class="mb-2">
                @if (!string.IsNullOrWhiteSpace(Model.ExerciseFilePath))
                {
                    <div>
                        <strong>Exercise file:</strong>
                        <a href="@Model.ExerciseFilePath" target="_blank">Download</a>
                    </div>
                }
                @if (!string.IsNullOrWhiteSpace(Model.GuideFilePath))
                {
                    <div>
                        <strong>Guide file:</strong>
                        <a href="@Model.GuideFilePath" target="_blank">Download</a>
                    </div>
                }
            </div>
        }
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Submissions</h5>
            <span class="small text-muted">
                Total: @Model.Submissions.Count
            </span>
        </div>

        @if (!Model.Submissions.Any())
        {
            <p class="text-muted small mb-0">No submissions yet.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Student</th>
                            <th>Submitted at</th>
                            <th>File</th>
                            <th>Score</th>
                            <th>Comment</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in Model.Submissions)
                        {
                            <tr class="@(s.IsLate ? "table-warning" : "")">
                                <td>
                                    @s.StudentCode - @s.StudentName
                                </td>
                                <td>
                                    @if (s.SubmittedAt.HasValue)
                                    {
                                        @s.SubmittedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                        if (s.IsLate)
                                        {
                                            <span class="badge bg-warning text-dark ms-1">Late</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Not submitted</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrWhiteSpace(s.FilePath))
                                    {
                                        <a href="@s.FilePath" target="_blank">Download</a>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td>
                                    @if (s.Score.HasValue)
                                    {
                                        @s.Score
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="small">
                                    @if (!string.IsNullOrWhiteSpace(s.TeacherComment))
                                    {
                                        @s.TeacherComment
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                                <td class="text-end">
                                    @if (s.SubmittedAt.HasValue)
                                    {
                                        <form asp-controller="Assignments"
                                              asp-action="Grade"
                                              method="post"
                                              class="d-inline-flex align-items-center gap-1">
                                            <input type="hidden" name="submissionId" value="@s.SubmissionId" />
                                            <input type="hidden" name="assignmentId" value="@Model.Id" />

                                            <input type="number"
                                                   name="score"
                                                   class="form-control form-control-sm"
                                                   style="width: 80px;"
                                                   value="@(s.Score ?? 0)"
                                                   min="0" />

                                            <input type="text"
                                                   name="comment"
                                                   class="form-control form-control-sm"
                                                   style="width: 160px;"
                                                   value="@s.TeacherComment" />

                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-primary">
                                                Save
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">No submission</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<a asp-action="Index" class="btn btn-secondary btn-sm mt-3">Back</a>
